services:
  video-detector-cpu:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: video-detector-cpu
    volumes:
      - ./input:/data/input
      - ./output:/data/output
      - ./logs:/data/logs
      - ./trained_models:/data/models
    environment:
      - WATCH_FOLDER=/data/input
      - OUTPUT_FOLDER=/data/output
      - MODELS_FOLDER=/data/models
      - LOG_FILE=/data/logs/app.log
      - FORCE_CPU=true
      - FRAME_FAKE_THRESHOLD=0.5
      - VIDEO_FAKE_THRESHOLD=0.4
      - INFERENCE_BATCH_SIZE=32
      - DETECTOR_BACKEND=dlib
    restart: unless-stopped

  video-detector-cuda:
    build:
      context: .
      dockerfile: Dockerfile.cuda
    container_name: video-detector-cuda
    volumes:
      - ./input:/data/input
      - ./output:/data/output
      - ./logs:/data/logs
      - ./trained_models:/data/models
    environment:
      - WATCH_FOLDER=/data/input
      - OUTPUT_FOLDER=/data/output
      - MODELS_FOLDER=/data/models
      - LOG_FILE=/data/logs/app.log
      - NVIDIA_VISIBLE_DEVICES=all
      - AUTO_FALLBACK_CPU_ON_UNSUPPORTED_CUDA=true
      - FRAME_FAKE_THRESHOLD=0.5
      - VIDEO_FAKE_THRESHOLD=0.4
      - INFERENCE_BATCH_SIZE=32
      - DETECTOR_BACKEND=retinaface
      - RETINAFACE_DET_SIZE=640
      - RETINAFACE_BOX_SCALE=1.25
    gpus: all
    restart: unless-stopped
    profiles:
      - cuda

  video-detector-mps:
    build:
      context: .
      dockerfile: Dockerfile.mps
    platform: linux/arm64
    container_name: video-detector-mps
    volumes:
      - ./input:/data/input
      - ./output:/data/output
      - ./logs:/data/logs
      - ./trained_models:/data/models
    environment:
      - WATCH_FOLDER=/data/input
      - OUTPUT_FOLDER=/data/output
      - MODELS_FOLDER=/data/models
      - LOG_FILE=/data/logs/app.log
      - FORCE_CPU=false
      - FRAME_FAKE_THRESHOLD=0.5
      - VIDEO_FAKE_THRESHOLD=0.4
      - INFERENCE_BATCH_SIZE=32
      - DETECTOR_BACKEND=retinaface
      - RETINAFACE_DET_SIZE=640
      - RETINAFACE_BOX_SCALE=1.25
    restart: unless-stopped
    profiles:
      - mps
